---
title: "Solution: Pathway and gene set enrichment analysis"
author: "Updated from Charlie George"
date: "23/10/2024"
---

# Introduction

In this notebook, we use [gprofiler2](https://CRAN.R-project.org/package=gprofiler2) to demonstrate over-representation analysis
and [fgsea](https://bioconductor.org/packages/fgsea/) to demonstrate gene set enrichment analysis (GSEA)
on an output table of differentially expression statistics obtained using [DESeq2](https://bioconductor.org/packages/fgsea/).

The key goals of these exercises are:

- to encourage you to read package documentation and online information about the methods.
- to encourage you to experiment with the various parameters of the various functions and interpret the outputs

# Load libraries

We give you the following code chunk to load libraries in a certain order,
which should avoid any surprise during the lesson
and help you focus on the exercise.

It also sets an option that will help you with rendering the notebook at the end,
if you decide to try.

```{r}
#| message: false
library(tidyverse)
library(gprofiler2)
options(bitmapType = 'cairo') # For rendering 
```

# Over-representatin analysis (ORA)

## Load libraries

The following code chunk loads the necessary libraries for this section.

It is redundant because you should have loaded those libraries already in a code chunk above.
However, you may find it a useful reminder of the packages relevant to this set of exercises.

```{r}
#| message: false
library(tidyverse)
library(gprofiler2)
```

## Input data

Use the `read_csv()` function to read a table of differential expression statistics that we produced using DESeq2.

```{r}
all_genes_df <- read_csv("data/dds_results.csv")
```

It is a good idea to get familiar with the data before using it.

First use the `dim()` function to check the dimensions of the `all_genes_df` object.

```{r}
dim(all_genes_df)
```

Now, use the `head()` function to visually inspect the first few rows of the `all_genes_df` object.

```{r}
head(all_genes_df)  
```

## Prepare query gene sets

In the following code chunks, we would like you to create three tables,
each of them a subset of `all_genes_df`.

First, create `all_genes_tested_df` containing table of all genes tested in the differential expression analysis.
Those genes can be identified by the fact that they have an adjusted P-value,
while genes excluded by DESeq2's independent filtering method will have `NA` as their adjusted P-value.
Here, you'll want to filter out those last ones.

If you feel like reading, here's a relevant piece of DESeq2 documentation:
<https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#why-are-some-p-values-set-to-na>

```{r}
all_genes_tested_df <- all_genes_df %>%
  dplyr::filter(!is.na(padj))
```

Second, create `upreg_genes_df` containing all significantly up-regulated genes.
Here, you'll want to filter `all_genes_df` to retain genes with an adjusted P-value lower than 0.05 and a log2 fold-change greater than 1 (feel free to pick your own favourite cutoff values).

```{r}
upreg_genes_df <- all_genes_tested_df %>% 
  dplyr::filter(padj < 0.05 & log2FoldChange > 1)
```

Third, same logic but create `downreg_genes_df` containing all significantly down-regulated genes.

```{r}
downreg_genes_df <- all_genes_tested_df %>% 
  dplyr::filter(padj < 0.05 & log2FoldChange < -1)
```

One quick way to get a sense of how many genes you have in each of those data frames is to check their dimensions.
Run the `dim()` function on each of the three data sets you've just created.
They should have the same number of columns (since we only filtered rows), but different numbers of rows.

```{r}
dim(all_genes_df)
dim(all_genes_tested_df)
dim(upreg_genes_df)
dim(downreg_genes_df)
```

- From each of the 3 data frames, get a vector of the Ensembl ids.

```{r}
all_gene_tested_ids <- all_genes_tested_df %>% pull(gene_id)
upreg_gene_ids <- upreg_genes_df %>% pull(gene_id)
downreg_gene_ids <- downreg_genes_df %>% pull(gene_id)
```

## Perform ORA using gprofiler2

a. First, we want to do ORA on upregulated genes (vs. all genes tested as background). What function from gprofiler2 should we use? What parameters of that function should we include or change? Look at the [documentation](https://cran.r-project.org/web/packages/gprofiler2/vignettes/gprofiler2.html). 

```{r}
?gost() # Get help for function

# Write ORA query
gost_results_obj <- gost(query = upreg_gene_ids, 
                         organism = "mmusculus", 
                         ordered_query = FALSE,    
                         multi_query = FALSE, 
                         significant = TRUE, 
                         exclude_iea = TRUE, 
                         measure_underrepresentation = FALSE, 
                         evcodes = FALSE, 
                         user_threshold = 0.05, 
                         correction_method = "g_SCS",  
                         domain_scope = "custom_annotated",
                         custom_bg = all_gene_tested_ids, 
                         numeric_ns = "", 
                         sources = NULL, 
                         as_short_link = FALSE,
                         highlight = FALSE)
                         

# gost() parameters:

## `ordered_query` - Change to `TRUE` if input gene list is ranked; "testing is then performed iteratively, starting from the first gene and sequentially adding genes one by one" (kolberg_gprofiler2_2020)

## `exclude_iea` - Change to `TRUE` if we want to be stringent with gene sets considered i.e. only look at curated GO gene sets

## measure_underrepresentation - whether overlap is less than expected

## `correction_method = "g_SCS"` - This is their own multiple testing correction; more stringent than Bonferroni or Benjamini-Hochberg, takes into account the unevenly distributed structure of functionally annotated gene sets

## `domain_scope = "custom_annotated"` - "Use the set of genes that are annotated in the data source and are also included in the user provided background list (documentation)"

## `sources` - "We recommend that initial pathway enrichment analyses includes only biological processes (BPs) of GO and molecular pathways of Reactome. Large pathways are of limited interpretative value, whereas numerous small pathways decrease the statistical power because of excessive multiple testing. (doi: 10.1038/s41596-018-0103-9)"

# gost() output coulumns - See gprofiler2 documentation

## query_size - could be different depending on the source of gene sets/pathways because it considers genes annotated in the source

## precision - "the proportion of genes in the input list that are annotated to the function (defined as intersection_size/query_size)"

## recall - "the proportion of functionally annotated genes that the query recovers (defined as intersection_size/term_size)"

## effective_domain_size - Different per source when `domain_scope = "custom_annotated"` as in query_size because not all background genes are annotated in the source

## source_order - "numeric order for the term within its data source (this is important for drawing the results)"; closely related terms are closer to each other in the order
```

- What type of object is the output? Explore contents.

```{r}
class(gost_results_obj)
summary(gost_results_obj)
```

b. Plot our results using a function from gprofiler2. Which one is it? 

```{r}
gostplot(gost_results_obj, capped = TRUE, interactive = TRUE)

## size of circle - term size
```

c. What does `as_short_link = TRUE` do in `gost()` function? 

```{r}
gost_results_obj_link <- gost(query = upreg_gene_ids, 
                         organism = "mmusculus", 
                         ordered_query = FALSE,    
                         multi_query = FALSE, 
                         significant = TRUE, 
                         exclude_iea = TRUE, 
                         measure_underrepresentation = FALSE, 
                         evcodes = FALSE, 
                         user_threshold = 0.05, 
                         correction_method = "g_SCS",  
                         domain_scope = "custom_annotated",
                         custom_bg = all_gene_tested_ids, 
                         numeric_ns = "", 
                         sources = NULL, 
                         as_short_link = TRUE,
                         highlight = FALSE)

gost_results_obj_link

# This gives you a url where you can quickly and easily visualise your data and send the link to others to see it too
# Check 'Detailed Results' tab; see g:Profiler docs (https://biit.cs.ut.ee/gprofiler/page/docs) to learn more about the website
```

d. Filter results table for gene sets with between 5-300 genes, inclusive. Examine results subset.

```{r}
gost_results_obj_filtered_df <- gost_results_obj$result
gost_results_obj_filtered_df <- gost_results_obj_filtered_df %>%
  filter(term_size >= 5 & term_size <= 300) %>% 
  arrange(p_value)

#

gost_results_obj_filtered <- gost_results_obj
gost_results_obj_filtered$result <- gost_results_obj_filtered_df
gostplot(gost_results_obj_filtered, capped = TRUE, interactive = TRUE)
```

e. Try querying multiple gene lists at the same time (up and down regulated genes) using the parameter to specify multiple queries.

```{r}
multi_gostquery_results_obj <- gost(query = list("upreg_genes" = upreg_gene_ids,
                                                 "downreg_genes"= downreg_gene_ids),
                                    organism = "mmusculus", 
                                    multi_query = FALSE,
                                    exclude_iea = TRUE, 
                                    correction_method = "g_SCS", 
                                    domain_scope = "custom_annotated",
                                    custom_bg = all_gene_tested_ids)
```

f. Can you plot these queries together?

```{r}
gostplot(multi_gostquery_results_obj, capped = TRUE, interactive = TRUE)
```

g. Output the `get_version_info()` to save the versions of the databases that were used for the analysis!
```{r}
get_version_info('mmusculus')
```

# GSEA

- We will use the [**fgsea**](https://bioconductor.org/packages/release/bioc/vignettes/fgsea/inst/doc/fgsea-tutorial.html) R package to perform GSEA on the output table of differentially expressed genes from DESeq2.

- The major aims of this exercise is to get you used to reading online tool documentation, playing with different parameters of the relevant functions and interpreting outputs.

## Load libraries

```{r}
library(dplyr)
library(tidyverse)
library(fgsea)
library(msigdbr)
```

## Read in output table of differentially expressed genes from DESeq2

```{r}
all_genes_df <- read_csv("data/dds_results.csv")
```

## Create input gene list

- Create **all_genes_tested_df** object containing table of all genes tested in the differential expression analysis.

```{r}
all_genes_tested_df <- all_genes_df %>%
  dplyr::filter(!is.na(padj))
```

- All we’ll care about later on is the gene identifier and a gene-level statistic to rank the genes i.e. log2FoldChange. Simplify table by getting just those columns.

```{r}
all_genes_tested_df <- all_genes_tested_df %>%
  dplyr::select(gene_id,log2FoldChange)
```

- Check whether you have genes with multiple entries.

```{r}
any(duplicated(all_genes_tested_df$gene_id)) # Gene ids are unique so we'll just proceed
```

## Obtain list of gene sets

a. The `fgsea()` function requires (1) a list of gene sets / pathways to test enrichment of, and (2) a named vector of gene-level statistic (log2FoldChange), where the names should be the same as the gene names in the gene sets / pathways. First, let’s create our named vector of log2FoldChange values. 

- See `?tibble::deframe` for help here. The `deframe()` function converts 2-column data frames to a named vector or list, using the first column as name and the second column as value.

```{r}
ranks <- deframe(all_genes_tested_df)
plot(ranks)
```

- Sort the genes based on the ranking metric.

```{r}
ranks <- sort(ranks, decreasing = TRUE)
plot(ranks)
```

b. Obtain gene sets / pathways. Let’s use the [Hallmark gene sets from MSigDB](https://www.gsea-msigdb.org/gsea/msigdb/human/collections.jsp). "Hallmark gene sets summarise and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression." 

We can either download GMT files directly from MSigDB or use the [misgidbr](https://cran.r-project.org/web/packages/msigdbr/index.html) R package. We'll do the latter. Check the [documentation](https://cran.r-project.org/web/packages/msigdbr/vignettes/msigdbr-intro.html) for the functions we need. 

- Use a helper function from misgidbr to show the available species.

```{r}
msigdbr_species()
```

- Retrieve the hallmark gene sets as **h_gene_sets** object. 

```{r}
h_gene_sets <- msigdbr(species = "Mus musculus", # Either scientific or common name is acceptable
                       category = "H")

# If you want all the gene sets:
# all_gene_sets = msigdbr(species = "mouse")
```

- What is the class of the output. Explore contents. 

```{r}
class(h_gene_sets)
h_gene_sets
```

- Remove genes in `h_gene_sets` that were not considered in the differential expression analysis.

```{r}
h_gene_sets_filtered <- h_gene_sets %>% 
  filter(ensembl_gene %in% all_genes_tested_df$gene_id)
```

- The `fgsea()` function accepts a **list** of gene sets. Create this list from **h_gene_sets** using base function `split()`.

```{r}
hallmark_list <- split(x = h_gene_sets_filtered$ensembl_gene,
                       f = h_gene_sets_filtered$gs_name)
```

## Perform GSEA using fgsea

```{r}
set.seed(190)
fgseaRes <- fgsea(pathways=hallmark_list, 
                  stats=ranks, 
                  maxSize=500)
head(fgseaRes)
```

- Convert result to tibble and arrange by normalised enrichment score

```{r}
fgseaResTidy <- fgseaRes %>%
  as_tibble() %>%
  arrange(desc(NES))
fgseaResTidy
```

- Plot the normalized enrichment scores per pathway. Arrange the pathways based on NES using `reorder()`. Colour the bar indicating whether or not the gene set / pathway was significant. 

```{r}
ggplot(fgseaResTidy, aes(NES, reorder(pathway, NES))) +
  geom_col(aes(fill = padj < 0.05)) +
  labs(x = "Normalized Enrichment Score", y = "",
       title = "Hallmark pathways NES from GSEA") + 
  theme_minimal()

# Use plotEnrichment() to plot GSEA enrichment plot per gene set / pathway
# plotEnrichment(hallmark_list[["HALLMARK_PEROXISOME"]], ranks) +
#   scale_y_continuous(limits = c(-0.2,0.2))
```

# sessionInfo

```{r}
sessionInfo()
```
