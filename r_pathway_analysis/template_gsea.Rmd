---
title: "Pathway and gene set enrichment analysis, GSEA"
author: "Updated from Charlie George"
date: "05/10/2023"
output: html_document
---

- We will use the [**fgsea**](https://bioconductor.org/packages/release/bioc/html/fgsea.html) R package to perform GSEA on the output table of differentially expressed genes from DESeq2.

- The major aims of this exercise is to get you used to reading online tool documentation, playing with different parameters of the relevant functions and interpreting outputs.

### 1. Load libraries.

```{r}
library(dplyr)
library(tidyverse)
library(fgsea)
library(msigdbr)
```

### 2. Read in output table of differentially expressed genes from DESeq2.

```{r}
all_genes_df <- read_csv("./data/dds_results.csv")
```

### 3. Create input gene list.

- Create **all_genes_tested_df** object containing table of all genes tested in the differential expression analysis.

```{r}
all_genes_tested_df <- 
```

- All we’ll care about later on is the gene identifier and a gene-level statistic to rank the genes i.e. log2FoldChange. Simplify list by getting just those columns.  

```{r}
all_genes_tested_df <- 
```

- Check whether you have genes with multiple entries. This is important particularly when using gene identifiers not unique to a transcript e.g. gene symbols. We'll have to deal with this e.g. by averaging log2FoldChange per gene. 

```{r}

```

### 4. Obtain list of gene sets / pathways

a. The `fgsea()` function requires (1) a list of gene sets / pathways to test enrichment of, and (2) a named vector of gene-level statistic (log2FoldChange), where the names should be the same as the gene names in the gene sets / pathways. First, let’s create our named vector of log2FoldChange values. 

- See `?tibble::deframe` for help here. The `deframe()` function converts 2-column data frames to a named vector or list, using the first column as name and the second column as value.

```{r}
ranks <- deframe()
```
b. Obtain gene sets / pathways. Let’s use the [Hallmark gene sets from MSigDB](https://www.gsea-msigdb.org/gsea/msigdb/human/collections.jsp). "Hallmark gene sets summarise and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression." 

We can either download GMT files directly from MSigDB or use the [misgidbr](https://cran.r-project.org/web/packages/msigdbr/index.html) R package. We'll do the latter. Check the [documentation](https://cran.r-project.org/web/packages/msigdbr/vignettes/msigdbr-intro.html) for the functions we need. 

- Use a helper function from misgidbr to show the available species.

```{r}
msigdbr_species()
```

- Retrieve the hallmark gene sets as **h_gene_sets** object. 

```{r}
h_gene_sets <- msigdbr()
```

- What is the class of the output. Explore contents. 

```{r}

```

- Remove genes in `h_gene_sets` that were not considered in the differential expression analysis.

```{r}
h_gene_sets_filtered <- 
```

- The `fgsea()` function accepts a **list** of gene sets. Create this list from **h_gene_sets** using base function `split()`. 

```{r}
hallmark_list <- split()
```

### 5. Perform GSEA using **fgsea**.

```{r}
fgseaRes <- fgsea()
```

- Convert result to tibble and arrange by normalised enrichment score

```{r}
fgseaResTidy <- 
```

- Plot the normalized enrichment scores per pathway. Arrange the pathways based on NES using `reorder()`. Colour the bar indicating whether or not the gene set / pathway was significant. 

```{r}
ggplot(fgseaResTidy, aes(NES, reorder())) +
```

### 6. Output the sessionInfo() to have a record of packages used.

```{r}
sessionInfo()
```

### 7. Knit your report into an HTML 

- This is good practise as it creates a permanent record of your plots/analysis outputs that you can share.
- This also makes sure your script runs without error from start to finish! 
