---
title: "Pathway and gene set enrichment analysis, ORA"
author: "Updated from Charlie George"
date: "05/10/2023"
output: html_document
---

- We will use the [**gprofiler2**](https://cran.r-project.org/web/packages/gprofiler2/index.html) R package to perform an over-representation analysis (ORA) on the output table of differentially expressed genes from DESeq2.

- The major aims of this exercise is to get you used to reading online tool documentation, playing with different parameters of the relevant functions and interpreting outputs.

### 1. Load libraries.

```{r}
library(dplyr)
library(tidyverse)
library(gprofiler2)
```

### 2. Read in output table of differentially expressed genes from DESeq2.

```{r}
all_genes_df <- read_csv("./data/dds_results.csv")
```
- Check its dimensions and look at the top of the file. What does that tell us about our table? 

```{r}
dim(all_genes_df)
```

```{r}
head(all_genes_df)  
```

- What type of R object is the table?

```{r}
class(all_genes_df)
```

### 3. Create input gene lists.

- Create these 3 data frames by subsetting the original one:
  + **all_genes_tested_df** object containing table of all genes tested in the differential expression analysis, which will be the background or control set
  + **upreg_genes_df** object containing all significantly upregulated genes ('padj' < 0.05 & 'log2FoldChange' > 1)
  + **downreg_genes_df** object containing all significantly downregulated genes ('padj' < 0.05 & 'log2FoldChange' < -1)

```{r}
all_genes_tested_df <- all_genes_df %>% 
                          dplyr::filter(padj !="NA")
  
upreg_genes_df <- all_genes_tested_df %>% 
                     dplyr::filter(padj < 0.05 & log2FoldChange > 1)

downreg_genes_df <- all_genes_tested_df %>% 
                       dplyr::filter(padj < 0.05 & log2FoldChange < -1)
```

- Check the dimensions of the data frames.

```{r}
dim(all_genes_tested_df)
dim(upreg_genes_df)
dim(downreg_genes_df)
```

- From each of the 3 data frames, get a vector of the Ensembl ids.

```{r}
all_gene_ids <- all_genes_tested_df %>% pull(gene_id)
upreg_gene_ids <- upreg_genes_df %>% pull(gene_id)
downreg_gene_ids <- downreg_genes_df %>% pull(gene_id)
```

### 4. Perform ORA using **gprofiler2**.

a. First, we want to do ORA on upregulated genes  (vs. all genes tested as background). What function from gprofiler2 should we use? What parameters of that function should we include or change? Look at the [documentation](https://cran.r-project.org/web/packages/gprofiler2/vignettes/gprofiler2.html). 

```{r}
?gost() # Get help for function

# Write ORA query
gost_results_obj <- gost(query = upreg_gene_ids, 
                         organism = "mmusculus", 
                         ordered_query = FALSE,    
                         multi_query = FALSE, 
                         significant = TRUE, 
                         exclude_iea = TRUE, 
                         measure_underrepresentation = FALSE, 
                         evcodes = FALSE, 
                         user_threshold = 0.05, 
                         correction_method = "g_SCS",  
                         domain_scope = "custom_annotated",  
                         custom_bg = all_gene_ids, 
                         numeric_ns = "", 
                         sources = NULL, 
                         as_short_link = FALSE,
                         highlight = FALSE)

# `exclude_iea` - Change to `TRUE` if we want to be stringent with gene sets considered i.e. only look at well-annotated gene sets
# `correction_method = "g_SCS"` - This is their own multiple testing correction; more stringent than Bonferroni or Benjamini-Hochberg
# `domain_scope` - No need to set if providing custom background
# `custom_bg = all_gene_ids` - # Background gene list
```

- What type of object is the output? Explore contents.

```{r}
class(gost_results_obj)
summary(gost_results_obj)
```

b. Plot our results using a function from gprofiler2. Which one is it? 

```{r}
gostplot(gost_results_obj, capped = TRUE, interactive = TRUE)
```

c. What does `as_short_link = FALSE` do in `gost()` function? 

```{r}
gost_results_obj_link <- gost(query = upreg_gene_ids, 
                         organism = "mmusculus", 
                         ordered_query = FALSE,    
                         multi_query = FALSE, 
                         significant = TRUE, 
                         exclude_iea = TRUE, 
                         measure_underrepresentation = FALSE, 
                         evcodes = FALSE, 
                         user_threshold = 0.05, 
                         correction_method = "g_SCS",  
                         domain_scope = "custom_annotated", # 
                         custom_bg = all_gene_ids, 
                         numeric_ns = "", 
                         sources = NULL, 
                         as_short_link = TRUE,
                         highlight = FALSE)
gost_results_obj_link

# This gives you a url where you can quickly and easily visualise your data and send the link to others to see it too
# Check 'Detailed Results' tab; see g:Profiler docs (https://biit.cs.ut.ee/gprofiler/page/docs) to learn more about the website
```

d. Filter results table for gene sets with between 5-300 genes, inclusive. 

```{r}
gost_results_df <- gost_results_obj$result
gost_results_df_5to300_genes <- gost_results_df  %>% 
                                  filter(term_size >= 5) %>% 
                                  filter(term_size <= 300)
head(gost_results_df_5to300_genes)
```

e. Try querying multiple gene lists at the same time (up and down regulated genes) using the parameter to specify multiple queries.

```{r}
multi_gostquery_results_obj <- gost(query = list("upreg_genes" = upreg_gene_ids,
                                                 "downreg_genes"= downreg_gene_ids),
                                    organism = "mmusculus", 
                                    multi_query = TRUE,
                                    exclude_iea = TRUE, 
                                    correction_method = "g_SCS", 
                                    custom_bg = all_gene_ids)
```

f. Can you plot these queries together?

```{r}
gostplot(multi_gostquery_results_obj, capped = TRUE, interactive = TRUE)
```

g. Output the get_version_info() to save the versions of the databases that were used for the analysis!
```{r}
get_version_info('mmusculus')
```

### 5. Output the sessionInfo() to have a record of packages used.

```{r}
sessionInfo()
```

### 6. Knit your report into an HTML 

- This is good practise as it creates a permanent record of your plots/analysis outputs that you can share.
- This also makes sure your script runs without error from start to finish! 
