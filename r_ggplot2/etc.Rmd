# Plots - Visualise and comprehend data

```{r, include=TRUE, echo=FALSE, fig.align='center'}
knitr::include_graphics("img/data-visualisation.png")
# Source: https://www.autodesk.com/autodesk-university/article/Turn-Revit-Data-Useful-Information-Visualization-Techniques-and-Workflows-2019
```

---

# Plots - Beyond summary statistics

```{r, include=TRUE, echo=FALSE, fig.align='center'}
knitr::include_graphics("img/plot-same-mean.gif")
# Source: https://www.variancereduction.com/single-post/2017/06/12/same-stats-different-graphs-the-importance-of-data-visualization
```

---

# Plots, plots everywhere!

```{r, include=TRUE, echo=FALSE, fig.align='center', out.height='500px'}
knitr::include_graphics("img/plots-plots-everywhere.jpg")
# Source: https://makeameme.org/meme/plots-plots-everywhere
```

---

# Plotting in base <i class="fab fa-r-project"></i>

```{r, include=TRUE, fig.align='center', fig.height=4, fig.width=8}
hist(x = iris$Sepal.Length, breaks = 25, xlab = "Sepal Length",
  main = "Histogram of sepal lengths", col = "grey90", border = "red",
  xlim = c(4, 8), cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)
```

```{r, include=TRUE}
head(iris$Sepal.Length)
```

---

# Tidy data

```{r, include=TRUE}
head(iris)
```

```{r, include=TRUE}
summary(iris)
```

---

# Plotting tidy data with `r BiocStyle::CRANpkg("ggplot2")`

```{r, include=TRUE, fig.align='center', fig.height=4.5, fig.width=8}
library(ggplot2)
plot1 <- ggplot(iris, aes(x = Sepal.Length)) +
  geom_histogram(fill = "grey", color = "black") +
  labs(title = "Histogram of sepal lengths", y = "Frequency", x = "Sepal length") +
  theme(text = element_text(size = 16))
print(plot1)
```

---

# `r BiocStyle::CRANpkg("ggplot2")`

.pull-left[
- Currently the most popular plotting framework in <i class="fab fa-r-project"></i>

- Uses tidy data (part of the `r BiocStyle::CRANpkg("tidyverse")`)

  + e.g. `data.frame`, `datatable`, `tibble`
  
  + One row = one data point
  
  + One column = one property of data points, e.g. position on x axis, color, size

- Introduction and Cheatsheet: <https://ggplot2.tidyverse.org/>
]

.pull-right[
```{r, include=TRUE, echo=FALSE, fig.align='center'}
knitr::include_graphics("img/rstudio-cheatsheet-ggplot.png")
# Source: https://makeameme.org/meme/plots-plots-everywhere
```
]

---

# Geometric objects

A **layer** combines **data**, **aesthetic** mapping, a **geom** (geometric object), a **stat** (statistical transformation), and a **position** adjustment.
Typically, you will create layers using a `geom_*` function,
occasionally overriding the default **position** and **stat** if needed.

Reference: <https://ggplot2.tidyverse.org/reference/#section-geoms>

- `geom_point()` - scatter plot, requires `x` and `y`.

- `geom_histogram()` - histogram, requires `x` (continuous).

- `geom_bar()` - histogram, requires `x` (categorical).

- `geom_col()` - histogram, requires `x` and `y`.

- `geom_boxplot()` - boxplot, requires `x` and/or `y`.

- `geom_line()` - connect consecutive observations with line, requires `x` and `y`.

**Note:** refer to man pages for optional and alternative aesthetics for each **geom**.

---

# Exercise with the built-in `diamonds` dataset

```{r, include=TRUE}
diamonds
```

**Note:** refer to the man page for more information about each column.

---

# Exercise

## Specify the dataset.

Use `library(ggplot2)` to load the package.

What does `ggplot(diamonds)` do?

## Add the aesthetics.

What does `ggplot(diamonds, aes(x = carat, y = price))` do?

## Add geometric objects

- Add data points showing `carat` on the x-axis and `price` on the y-axis.

- Color data points by `cut`.

- Add a smoothed mean trend line.

- Save the last plot as an object called `obds_diamonds`.

---

# Exercise

## Spot (and predict) the difference!

### Plot 1

```{r, include=TRUE, eval=FALSE}
ggplot(diamonds, aes(x = carat, y = price, colour = cut)) +
  geom_point() +
  geom_smooth()
```

### Plot 2

```{r, include=TRUE, eval=FALSE}
ggplot(diamonds, aes(x = carat, y = price)) +
  geom_point(aes(colour = cut)) +
  geom_smooth()
```

.center[
**Predict the difference between these two plots**
]

---

# Answer

.pull-left[
.small-code[
```{r, include=TRUE, fig.height=4, fig.width=5, fig.align='center'}
ggplot(diamonds, aes(x = carat, y = price, colour = cut)) +
  geom_point() +
  geom_smooth()
```
]

**Note:** Colour aesthetic is passed to both `geom_point()` and `geom_smooth()`.
]

.pull-right[
.small-code[
```{r, include=TRUE, fig.height=4, fig.width=5, fig.align='center'}
ggplot(diamonds, aes(x = carat, y = price)) +
  geom_point(aes(colour = cut)) +
  geom_smooth()
```
]

**Note:** Colour aesthetic is only known to `geom_point()`.
]

---

# Themes

Themes are a powerful way to customize the non-data components of your plots, e.g.

- axis ticks - `element_line(colour, size, linetype, ...)`

- axis text - `element_text(family, face, colour, size, hjust, ...)`

- background - `element_rect(fill, colour, size, linetype, color, ...)`

```{r, include=TRUE, results='hide'}
theme(
  axis.ticks = element_line(size = 2),
  axis.text.x = element_text(face = "italic", hjust = 1),
  plot.background = element_rect(fill = "grey90", colour = "black")
)
```

You can get details of the current theme using `theme_get()`.

A number of presets are available, e.g. `theme_classic()`, `theme_minimal()`, `theme_bw()`.

**Note:** you can combine a preset theme with further customisation, e.g. `theme_minimal() + theme(...)`.

---

# Preset themes

```{r, include=TRUE}
base_plot <- ggplot(diamonds, aes(x = carat, y = price, colour = cut)) +
  geom_point()
```

.pull-left[
```{r, include=TRUE, fig.height=4, fig.align='center'}
base_plot + theme_classic()
```
]

.pull-left[
```{r, include=TRUE, fig.height=4, fig.align='center'}
base_plot + theme_dark()
```
]

---

# Customise the theme

```{r, include=TRUE, fig.height=5, fig.width=12, fig.align='center'}
base_plot +
  labs(title = "Diamond price and carat values",
  x = "Carat", y = "Price") +
  theme(axis.title = element_text(size = 16, face = "bold"),
  axis.text = element_text(size = 14),
  plot.title = element_text(hjust = 0.5, size = 20))
```

---

# Facets - Wrap

Wrap a 1-dimensional 'ribbon' of plots over dimensions using `facet_wrap(~variable)`:

```{r, include=TRUE, fig.height=5, fig.width=12, fig.align='center'}
ggplot(diamonds, aes(x = carat, y = price)) +
  geom_point() +
  facet_wrap(~cut, nrow = 2)
```

---

# Facets - Grid

Arrange plots by row and column following two variables using `facet_grid(row ~ column)`

```{r, include=TRUE, fig.height=5, fig.width=12, fig.align='center'}
ggplot(diamonds, aes(x = carat, y = price)) +
  geom_point() +
  facet_grid(cut ~ color)
```

---

# Exercise

## Trend lines

Using the `ChickWeight` data set:

- Create a scatter plot of weight (y-axis) over time (x-axis).

- Color by diet.

- Add a linear mean trend line for each diet.

At this point you should be able to visually identify
the diet that leads to the highest mean increase in weight.

- Facet a ribbon of sub-plots, one per diet.

- Save the last plot as an object called `obds_chickweight`.

---

# Exercise

## Bar plot

- Load the `ggplot2::msleep` data set.

- Draw a bar plot of number of observations by taxonomic order.

- Change the angle and font size of the x-axis tick labels.
  Justify the text labels as right-aligned.

- Change the label and font size of the axes.

- Fill each bar with colors, proportionally to the count of each genus.

> From this point onwards, you may need to iteratively resize the labels of the ticks and axes.

- Reduce the legend key size.
  (Recommendation: use `unit(2, "mm")`).

- Force the legend to be display in 3 columns.
  (Recommendation: use `guide_legend(...)`).

- Add a contour of thin black lines to the bars.

- Save the last plot as an object called `obds_msleep`.

---

# Plot grids - cowplot

```{r, include=TRUE, fig.height=5, fig.width=12, fig.align='center'}
plot1 <- base_plot + theme_classic() + labs(title = "Theme classic")
plot2 <- base_plot + theme_dark() + labs(title = "Theme dark")
library(cowplot)
plot_grid(plot1, plot2, labels = c("A", "B"), ncol = 2, nrow = 1)
```

---

# Plot grids - patchwork

```{r, include=TRUE, fig.height=5, fig.width=12, fig.align='center'}
library(patchwork)
plot1 + plot2
```

---

# Plot grids - gridExtra

```{r, include=TRUE, fig.height=5, fig.width=12, fig.align='center'}
library(gridExtra)
grid.arrange(plot1, plot2, ncol = 2, nrow = 1)
```

---

# Plot grids - gridExtra

```{r, include=TRUE, fig.height=6, fig.width=5, fig.align='center'}
library(gridExtra)
plot1 / plot2
```

---

# Save a plot to file

The `ggsave()` function can be used to save a plot to a file.

```{r, include=TRUE, eval=FALSE}
ggsave(
  filename,
  plot = last_plot(),
  ...
)
```

## Notes

- The first argument is the `filename`, not the `plot`!

- If `plot` is not given, the latest plot generated is used.

- The extension of `filename` is used to automatically generate the right kind of file.

---

# Exercise

## Plotting grid

- Collate the plots that we saved through the day, as a single plot.

  + Plots: `obds_diamonds`, `obds_chickweight`, `obds_msleep`.
  
  + Methods: `cowplot::plot_grid()`, `patchwork`, `gridExtra::grid.arrange()`.

- Save the new plot in a PDF file, and open it in a PDF viewer (e.g. Adobe Acrobat Reader DC).

> You will likely need a few attempts to fine-tune the width and height of the output file.

---

# Summary

## Key points

- `r BiocStyle::CRANpkg("ggplot2")` uses **tidy** data (it is part of the `r BiocStyle::CRANpkg("tidyverse")`).

- **Geoms** define _how_ data are represented (e.g., points, lines, bars).

- **Aesthetics** define the mapping between columns of data and properties of the **geom** (e.g., x, y, color, size).

- **Themes** control aspects of the plot that are not related to data (e.g., background, fonts).

- **Faceting** is built in `r BiocStyle::CRANpkg("ggplot2")` to subdivide a plot by faceting variables.

- Other packages provide tools for **arranging plots in a grid** (e.g., `r BiocStyle::CRANpkg("cowplot")`, `r BiocStyle::CRANpkg("patchwork")`, `r BiocStyle::CRANpkg("gridExtra")`).

- The function `ggsave()` can be used to **save a plot to a range of file formats** (e.g. PDF, PNG).

- A [ggplot2 cheatsheet](https://www.rstudio.com/resources/cheatsheets/) is available from the RStudio website.

---

# Exercise

## Pair programming

Explore the data set `ggplot2::mpg` and generate the most informative plot that you can!

```{r, include=TRUE, echo=FALSE, fig.align='center', fig.height=6}
ggplot(mpg, aes(cty, hwy, color = year)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point(size = 0.5) +
  facet_wrap(~manufacturer)
```

---

# Further reading

## ggplot2

- Introduction and Cheatsheet: <https://ggplot2.tidyverse.org/>

## gridExtra

- Arranging multiple grobs on a page:  <https://cran.r-project.org/web/packages/gridExtra/vignettes/arrangeGrob.html>

---

# Git wrap-up

- Copy your notebook for this lesson in the Git repository, e.g.

.small-code[

> ```
> cp \
>   /project/obds/$USER/projects/object_oriented_programming_ggplot2/ggplot2-kevinrue.Rmd \
>   /project/obds/$USER/git/week2day4-ggplot2/
> ```

]

- Similarly, copy your notebook for the object-oriented programming lesson in the Git repository, e.g.

.small-code[

> ```
> cp \
>   /project/obds/$USER/projects/object_oriented_programming_ggplot2/object_oriented_programming-kevinrue.Rmd \
>   /project/obds/$USER/git/week2day4-object_oriented_programming/
> ```

]

- Create a new branch in the Git repository.
  Use the date and your username in the branch name to make it unique, e.g. `git checkout -b week2day4-kevinrue`.

- Commit, push, open a pull request, get it approved, and merge it.

- Delete your merged branch on GitHub.

- Check out the main branch locally, pull, and delete your merged branch locally.

---

# References

.small-text[
```{r, include=TRUE, echo=FALSE, results="asis"}
PrintBibliography(bib)
```
]
